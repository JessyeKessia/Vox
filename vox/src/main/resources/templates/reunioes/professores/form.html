<!DOCTYPE html>
<html lang="pt_BR"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}"
      th:with="titulo='Votar nos Processos da Reunião'">

<body class="bg-light">

<section layout:fragment="content" class="py-4">
    <div class="container-fluid">

        <div class="card border-0 shadow-sm">
            <div class="card-body">

                <h1 class="h4 mb-2 text-dark">Votação dos Processos da Reunião</h1>
                <p class="text-muted mb-4">
                    Registre seus votos para os processos em pauta.
                </p>

                <!-- INFO REUNIÃO -->
                <div class="row mb-4 p-3 rounded border bg-light">
                    <div class="col-md-6">
                        <span class="text-muted small text-uppercase">
                            Data da Reunião
                        </span><br>
                        <span class="fw-semibold"
                              th:text="${#temporals.format(reuniao.data, 'dd/MM/yyyy')}">
                        </span>
                    </div>

                    <div class="col-md-6">
                        <span class="text-muted small text-uppercase">
                            Status da Reunião
                        </span><br>
                        <span class="badge rounded-pill bg-info-subtle text-info"
                              th:text="${reuniao.status}">
                        </span>
                    </div>
                </div>

                <!-- LISTA DE PROCESSOS -->
                <div class="accordion" id="accordionProcessos">

                    <div class="accordion-item mb-2"
                         th:each="processo : ${reuniao.pauta}">

                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    th:data-bs-target="'#proc-' + ${processo.id}">

                                Processo #
                                <span th:text="${processo.numero}"></span>

                                <span class="badge ms-3 bg-warning-subtle text-warning"
                                      th:text="${processo.status}">
                                </span>

                                <!-- JÁ VOTOU -->
                                <span th:if="${votoMap != null and votoMap[processo.id] != null}"
                                      class="badge ms-2 bg-success">
                                    Voto registrado
                                </span>
                            </button>
                        </h2>

                        <div th:id="'proc-' + ${processo.id}"
                             class="accordion-collapse collapse"
                             data-bs-parent="#accordionProcessos">

                            <div class="accordion-body">

                                <form th:action="@{/professores/reunioes/voto/{reuniaoId}/{processoId}
                                    (reuniaoId=${reuniao.id}, processoId=${processo.id})}"
                                      method="post">

                                    <div class="row g-3">

                                        <!-- PROCESSO -->
                                        <div class="col-md-8">
                                            <div class="border rounded p-3 bg-white h-100">

                                                <p>
                                                    <strong>Assunto:</strong>
                                                    <span th:text="${processo.assunto.nome}"></span>
                                                </p>

                                                <p>
                                                    <strong>Aluno:</strong>
                                                    <span th:text="${processo.alunoInteressado.nome}"></span>
                                                </p>

                                                <p>
                                                    <strong>Descrição:</strong><br>
                                                    <span th:text="${processo.descricao}"></span>
                                                </p>

                                                <div th:if="${processo.requerimentoPdf != null}">
                                                    <a th:href="@{/processos/{id}/requerimento(id=${processo.id})}"
                                                       target="_blank"
                                                       class="btn btn-sm btn-outline-danger">
                                                        Ver PDF
                                                    </a>
                                                </div>

                                            </div>
                                        </div>

                                        <!-- RELATOR -->
                                        <div class="col-md-4">
                                            <div class="border rounded p-3 bg-white h-100">

                                                <p>
                                                    <strong>Relator:</strong>
                                                    <span th:text="${processo.relator.nome}"></span>
                                                </p>

                                                <p>
                                                    <strong>Voto do Relator:</strong><br>
                                                    <span th:classappend="${processo.decisaoRelator.name() == 'DEFERIDO'}
                                                        ? 'badge bg-success-subtle text-success'
                                                        : 'badge bg-danger-subtle text-danger'"
                                                          th:text="${processo.decisaoRelator}">
                                                    </span>
                                                </p>

                                                <strong>Parecer:</strong>
                                                <p class="small"
                                                   th:text="${processo.parecerTexto}">
                                                </p>

                                            </div>
                                        </div>

                                    </div>

                                    <!-- VOTO -->
                                    <div class="mt-3">
                                        <span class="text-muted small text-uppercase">
                                            Seu voto
                                        </span><br>

                                        <div class="form-check form-check-inline"
                                             th:each="tipo : ${tipoVotoItens}">

                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="tipoVoto"
                                                   th:value="${tipo}"
                                                   th:checked="${votoMap != null
                                                       and votoMap[processo.id] != null
                                                       and votoMap[processo.id].tipoVoto == tipo}"
                                                   th:disabled="${processo.status.name() != 'EM_PAUTA'
                                                    or (votoMap != null and votoMap[processo.id] != null)}"
                                                   required>

                                            <label class="form-check-label"
                                                   th:text="${tipo}">
                                            </label>
                                        </div>
                                    </div>

                                    <!-- BOTÃO -->
                                    <div class="mt-4 text-end">
                                        <button type="submit"
                                                class="btn btn-primary"
                                                th:disabled="${processo.status.name() != 'EM_PAUTA'
                                                    or (votoMap != null and votoMap[processo.id] != null)}">
                                            Votar
                                        </button>
                                    </div>

                                </form>

                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTÃO SAIR -->
                <div class="mt-4 text-end">
                    <a th:href="@{/professores/reunioes}"
                    class="btn btn-outline-danger"
                    th:classappend="${!todosProcessosVotados} ? 'disabled' : ''"
                    aria-disabled="true">
                        Sair da votação
                    </a>

                </div>
            </div>
            
        </div>
        
    </div>
</section>
<!-- SCRIPT -->
<script>
    function atualizarTela() {
        let todosVotados = true;

        document.querySelectorAll('[data-processo-id]').forEach(item => {
            const processoId = item.dataset.processoId;
            const jaVotado = item.dataset.votado === 'true';

            fetch(`/reunioes/processos/status/${processoId}`)
                .then(r => r.text())
                .then(status => {
                    const badge = item.querySelector('.status-badge');
                    const inputs = item.querySelectorAll('input, button');
                    const alert = item.querySelector('.status-alert');

                    badge.textContent = status;

                    if (status === 'EM_PAUTA' && !jaVotado) {
                        inputs.forEach(i => i.disabled = false);
                        if (alert) alert.style.display = 'none';
                        todosVotados = false;
                    } else {
                        inputs.forEach(i => i.disabled = true);
                        if (alert) alert.style.display = 'block';
                    }

                    if (!jaVotado) {
                        todosVotados = false;
                    }
                });
        });

        document.getElementById('btnSair').disabled = !todosVotados;
    }

    atualizarTela();
    setInterval(atualizarTela, 5000);
</script>


</body>
</html>
